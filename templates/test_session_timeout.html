<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Timeout Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body data-user-id="test-user">
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h3>Session Timeout Test Page</h3>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <h5>Test Session Timeout Features:</h5>
                            <p>This page simulates the session timeout behavior for testing.</p>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h6>Quick Test (5 seconds)</h6>
                                        <p>Test the warning modal with a 5-second timeout</p>
                                        <button class="btn btn-primary" onclick="testQuickTimeout()">Test Quick Timeout</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h6>Real Timeout (30 min)</h6>
                                        <p>Test with actual 30-minute session timeout</p>
                                        <button class="btn btn-success" onclick="testRealTimeout()">Test Real Timeout</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <h6>Session Status:</h6>
                            <div id="sessionStatus" class="alert alert-secondary">
                                Checking session status...
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <h6>Test Actions:</h6>
                            <button class="btn btn-outline-primary me-2" onclick="checkSession()">Check Session</button>
                            <button class="btn btn-outline-success me-2" onclick="extendSession()">Extend Session</button>
                            <button class="btn btn-outline-warning" onclick="clearSession()">Clear Session</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Mock session timeout for testing
        class TestSessionTimeout {
            constructor(options = {}) {
                this.sessionDuration = options.sessionDuration || 30 * 60 * 1000; // 30 minutes
                this.warningTime = options.warningTime || 5 * 60 * 1000; // 5 minutes
                this.checkInterval = options.checkInterval || 60 * 1000; // 1 minute
                this.serverCheckUrl = options.serverCheckUrl || '/auth/session-check';
                this.extendUrl = options.extendUrl || '/auth/extend-session';
                this.logoutUrl = options.logoutUrl || '/logout';
                
                this.sessionTimer = null;
                this.warningTimer = null;
                this.warningShown = false;
                this.isActive = true;
                
                this.updateStatus('Session timeout system initialized');
            }

            startSession() {
                this.clearTimers();
                this.warningShown = false;
                
                this.updateStatus(`Session started - expires in ${this.sessionDuration / 1000 / 60} minutes`);
                
                // Set warning timer
                this.warningTimer = setTimeout(() => {
                    this.showWarning();
                }, this.sessionDuration - this.warningTime);
                
                // Set session expiry timer
                this.sessionTimer = setTimeout(() => {
                    this.expireSession();
                }, this.sessionDuration);
            }

            showWarning() {
                if (this.warningShown) return;
                
                this.warningShown = true;
                const remainingTime = Math.ceil(this.warningTime / 1000 / 60);
                
                this.updateStatus(`‚ö†Ô∏è Warning: Session expires in ${remainingTime} minutes!`);
                
                // Create warning modal
                const modalHtml = `
                    <div class="modal fade" id="sessionWarningModal" tabindex="-1" aria-labelledby="sessionWarningModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header bg-warning">
                                    <h5 class="modal-title text-dark" id="sessionWarningModalLabel">
                                        <i class="fas fa-exclamation-triangle me-2"></i>Session Timeout Warning
                                    </h5>
                                </div>
                                <div class="modal-body">
                                    <div class="alert alert-warning">
                                        <strong>Your session will expire in <span id="countdown">${remainingTime}</span> minute(s).</strong>
                                    </div>
                                    <p>You will be automatically logged out unless you choose to stay logged in.</p>
                                    <div class="d-flex justify-content-between">
                                        <button type="button" class="btn btn-primary" id="stayLoggedInBtn">
                                            <i class="fas fa-clock me-2"></i>Stay Logged In
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" id="logoutNowBtn">
                                            <i class="fas fa-sign-out-alt me-2"></i>Logout Now
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove existing modal if any
                const existingModal = document.getElementById('sessionWarningModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Add modal to body
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('sessionWarningModal'));
                modal.show();
                
                // Setup button handlers
                document.getElementById('stayLoggedInBtn').addEventListener('click', () => {
                    this.extendSession();
                    modal.hide();
                });
                
                document.getElementById('logoutNowBtn').addEventListener('click', () => {
                    this.logout();
                });
                
                // Start countdown
                this.startCountdown();
            }

            startCountdown() {
                const countdownElement = document.getElementById('countdown');
                if (!countdownElement) return;
                
                let timeLeft = Math.ceil(this.warningTime / 1000 / 60);
                
                const countdownInterval = setInterval(() => {
                    timeLeft--;
                    if (countdownElement) {
                        countdownElement.textContent = timeLeft;
                    }
                    
                    if (timeLeft <= 0) {
                        clearInterval(countdownInterval);
                    }
                }, 60000); // Update every minute
            }

            extendSession() {
                this.updateStatus('‚úÖ Session extended successfully');
                this.startSession(); // Restart session timer
            }

            expireSession() {
                this.updateStatus('‚ùå Session expired - redirecting to login');
                // In real app, would redirect to login
                alert('Session expired! You would be redirected to login page.');
            }

            logout() {
                this.updateStatus('üö™ Logged out manually');
                alert('Logged out! You would be redirected to login page.');
            }

            clearTimers() {
                if (this.sessionTimer) {
                    clearTimeout(this.sessionTimer);
                    this.sessionTimer = null;
                }
                if (this.warningTimer) {
                    clearTimeout(this.warningTimer);
                    this.warningTimer = null;
                }
            }

            updateStatus(message) {
                const statusElement = document.getElementById('sessionStatus');
                if (statusElement) {
                    statusElement.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
                    statusElement.className = 'alert ' + (
                        message.includes('‚úÖ') ? 'alert-success' :
                        message.includes('‚ö†Ô∏è') ? 'alert-warning' :
                        message.includes('‚ùå') ? 'alert-danger' :
                        'alert-info'
                    );
                }
            }
        }

        // Initialize test session timeout
        let testSessionTimeout;

        // Test functions
        function testQuickTimeout() {
            testSessionTimeout = new TestSessionTimeout({
                sessionDuration: 10 * 1000, // 10 seconds
                warningTime: 5 * 1000       // 5 seconds warning
            });
            testSessionTimeout.startSession();
        }

        function testRealTimeout() {
            testSessionTimeout = new TestSessionTimeout({
                sessionDuration: 30 * 60 * 1000, // 30 minutes
                warningTime: 5 * 60 * 1000       // 5 minutes warning
            });
            testSessionTimeout.startSession();
        }

        function checkSession() {
            fetch('/auth/session-check')
                .then(response => response.json())
                .then(data => {
                    const status = data.valid ? '‚úÖ Valid session' : '‚ùå Invalid session';
                    document.getElementById('sessionStatus').innerHTML = 
                        `<strong>${new Date().toLocaleTimeString()}</strong>: ${status} - ${JSON.stringify(data)}`;
                })
                .catch(error => {
                    document.getElementById('sessionStatus').innerHTML = 
                        `<strong>${new Date().toLocaleTimeString()}</strong>: ‚ùå Error checking session - ${error}`;
                });
        }

        function extendSession() {
            fetch('/auth/extend-session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                const status = data.success ? '‚úÖ Session extended' : '‚ùå Failed to extend';
                document.getElementById('sessionStatus').innerHTML = 
                    `<strong>${new Date().toLocaleTimeString()}</strong>: ${status} - ${JSON.stringify(data)}`;
            })
            .catch(error => {
                document.getElementById('sessionStatus').innerHTML = 
                    `<strong>${new Date().toLocaleTimeString()}</strong>: ‚ùå Error extending session - ${error}`;
            });
        }

        function clearSession() {
            // Clear cookies to simulate session expiry
            document.cookie.split(";").forEach(function(c) { 
                document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
            });
            document.getElementById('sessionStatus').innerHTML = 
                `<strong>${new Date().toLocaleTimeString()}</strong>: üßπ Session cookies cleared`;
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('sessionStatus').innerHTML = 
                `<strong>${new Date().toLocaleTimeString()}</strong>: üöÄ Session timeout test page loaded`;
        });
    </script>
</body>
</html>
